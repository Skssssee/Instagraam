    <script>
        // --- CONFIGURATION ---
        const PRIMARY_API = "https://instaaaa-pi.vercel.app/download";
        // Agar Primary fail ho, toh yeh Backup API use karega (Cobalt Instance)
        const BACKUP_API_URL = "https://api.cobalt.tools/api/json"; 

        // --- PROXY LIST ---
        const PROXIES = [
            "", // 1. Direct (Sabse fast, agar API allow kare)
            "https://corsproxy.io/?", // 2. CorsProxy (Reliable)
            "https://api.allorigins.win/raw?url=", // 3. AllOrigins (GET only)
            "https://thingproxy.freeboard.io/fetch/" // 4. ThingProxy (Backup)
        ];

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('urlInput').value = text;
            } catch (err) {
                alert('Please allow clipboard access or paste manually.');
            }
        }

        async function fetchMedia() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();
            const loader = document.getElementById('loader');
            const resultArea = document.getElementById('resultArea');
            const errorMsg = document.getElementById('errorMsg');
            const submitBtn = document.getElementById('submitBtn');
            const playerContainer = document.getElementById('playerContainer');
            const fallbackCard = document.getElementById('fallbackCard');

            // Reset UI
            errorMsg.style.display = "none";
            resultArea.style.display = "none";
            playerContainer.innerHTML = "";
            fallbackCard.style.display = "none";
            
            if (!url.startsWith("http")) {
                showError("❌ Please paste a valid link first.");
                return;
            }

            // Start Loading
            loader.style.display = "block";
            submitBtn.disabled = true;
            submitBtn.textContent = "Connecting...";

            let mediaData = null;

            // --- STRATEGY 1: TRY PRIMARY API WITH MULTIPLE PROXIES ---
            for (const proxy of PROXIES) {
                console.log(`Trying Proxy: ${proxy || "Direct"}...`);
                try {
                    // Construct URL
                    const apiTarget = `${PRIMARY_API}?url=${encodeURIComponent(url)}`;
                    const finalUrl = proxy + (proxy ? encodeURIComponent(apiTarget) : apiTarget);
                    
                    // Fetch
                    const response = await fetch(finalUrl);
                    if (response.ok) {
                        const data = await response.json();
                        mediaData = parseMediaData(data);
                        if (mediaData && mediaData.link) break; // Found it! Stop searching.
                    }
                } catch (e) {
                    console.warn(`Proxy ${proxy} failed.`);
                }
            }

            // --- STRATEGY 2: IF PRIMARY FAILS, TRY COBALT (BACKUP API) ---
            if (!mediaData || !mediaData.link) {
                console.log("Primary API failed. Switching to Cobalt Backup...");
                submitBtn.textContent = "Trying Backup...";
                try {
                    const cobaltData = await fetchCobalt(url);
                    if (cobaltData) {
                        mediaData = {
                            link: cobaltData.url,
                            title: "Media File (Backup)",
                            desc: "Downloaded via Mizofy Backup",
                            type: "video" // Cobalt usually returns video
                        };
                    }
                } catch (e) {
                    console.error("Backup API failed", e);
                }
            }

            // --- FINAL RENDER ---
            loader.style.display = "none";
            submitBtn.disabled = false;
            submitBtn.textContent = "Download";

            if (mediaData && mediaData.link) {
                // Success
                document.getElementById('resTitle').textContent = mediaData.title || "Universal Media";
                document.getElementById('resAuthor').textContent = mediaData.desc || "Ready";
                document.getElementById('dlButton').href = mediaData.link;

                if (mediaData.type === "audio") {
                    playerContainer.innerHTML = `
                        <audio controls autoplay style="width:100%; margin-top:10px;">
                            <source src="${mediaData.link}" type="audio/mpeg">
                        </audio>`;
                } else {
                    playerContainer.innerHTML = `
                        <video controls autoplay playsinline class="media-preview" onerror="handleVideoError()">
                            <source src="${mediaData.link}" type="video/mp4">
                        </video>`;
                }
                resultArea.style.display = "block";
            } else {
                showError("❌ Server Busy. Please try again in 5 seconds.");
            }
        }

        // Helper: Cobalt API (POST Request)
        async function fetchCobalt(targetUrl) {
            try {
                const response = await fetch("https://corsproxy.io/?" + encodeURIComponent("https://api.cobalt.tools/api/json"), {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: targetUrl,
                        vQuality: "720",
                        filenamePattern: "basic"
                    })
                });
                const data = await response.json();
                if (data.status === "stream" || data.status === "redirect") return data;
                if (data.status === "picker") return data.picker[0];
                return null;
            } catch (e) {
                return null;
            }
        }

        // Helper: Parse Original API Data
        function parseMediaData(data) {
            const results = data.all_results || data.results || data; 
            let metadata = {
                link: data.clean_download_url || null,
                title: data.title,
                desc: data.author,
                type: "video"
            };

            if (metadata.link) return metadata;

            if (typeof results === 'object' && results !== null) {
                const items = Array.isArray(results) ? results : Object.values(results);
                for (const content of items) {
                    if (content && typeof content === 'object' && content.status !== 'failed') {
                        const keys = ["no_watermark", "no_watermark_hd", "video_url", "download_url", "url", "mp3"];
                        for (const key of keys) {
                            const link = content[key];
                            if (link && typeof link === 'string' && link.startsWith("http")) {
                                if (link.includes("token=") && link.length < 60) continue;
                                if ([".jpg", ".png", ".webp"].some(ext => link.toLowerCase().includes(ext))) continue;
                                metadata.link = link;
                                if (content.title) metadata.title = content.title;
                                if (key === "mp3" || (data.platform && data.platform.toLowerCase().includes("spotify"))) {
                                    metadata.type = "audio";
                                }
                                return metadata;
                            }
                        }
                    }
                }
            }
            return metadata.link ? metadata : null;
        }

        window.handleVideoError = function() {
            document.getElementById('playerContainer').innerHTML = ""; 
            document.getElementById('fallbackCard').style.display = 'block'; 
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
        }
    </script>
